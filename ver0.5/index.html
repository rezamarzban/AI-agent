<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Llama Agent</title>
    <style>
        body { font-family: system-ui, sans-serif; background: #f4f4f9; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: #2c3e50; color: white; padding: 15px; text-align: center; font-size: 1.4em; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; }
        .tab { padding: 12px 24px; cursor: pointer; background: #f8f9fa; }
        .tab.active { background: white; border-bottom: 3px solid #28a745; font-weight: bold; }
        .tab-content { display: none; padding: 20px; min-height: 60vh; }
        .tab-content.active { display: block; }
        #chat { height: 55vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; background: #fafafa; padding: 15px; }
        .message { padding: 12px 16px; border-radius: 10px; max-width: 85%; }
        .user { align-self: flex-end; background: #007bff; color: white; }
        .assistant { align-self: flex-start; background: white; border: 1px solid #ddd; white-space: pre-wrap; }
        .tool-used { align-self: flex-start; background: #e9f7ef; border-left: 4px solid #28a745; }
        .input-area { padding: 15px; display: flex; gap: 10px; background: white; border-top: 1px solid #eee; }
        textarea { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px; resize: none; height: 52px; }
        button { padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:hover { background: #218838; }
        .log { font-family: monospace; font-size: 0.9em; background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap; }
        .config-form input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; }
    </style>
</head>
<body>
<div class="container">
    <div class="header">Local Llama Agent</div>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab(0)">Chat</div>
        <div class="tab" onclick="switchTab(1)">Tools Interactions</div>
        <div class="tab" onclick="switchTab(2)">Tool Testing</div>
        <div class="tab" onclick="switchTab(3)">Config</div>
    </div>

    <!-- Chat Tab -->
    <div id="tab0" class="tab-content active">
        <div id="chat"><div class="message assistant">Hello! I am ready.</div></div>
        <div class="input-area">
            <textarea id="input" placeholder="Type your message..."></textarea>
            <button onclick="sendMessage()">Send</button>
        </div>
    </div>

    <!-- Tools Interactions -->
    <div id="tab1" class="tab-content">
        <button onclick="refreshLog()">Refresh Log</button>
        <div id="log" class="log"></div>
    </div>

    <!-- Tool Testing -->
    <div id="tab2" class="tab-content">
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <select id="tool-select"></select>
            <input id="tool-args" placeholder='{"query": "test"}' style="width:300px;padding:8px;">
            <button onclick="testTool()">Test Tool</button>
        </div>
        <pre id="test-result" class="log" style="display:none;margin-top:15px;"></pre>
    </div>

    <!-- Config Tab -->
    <div id="tab3" class="tab-content">
        <h3>API Configuration</h3>
        <div class="config-form">
            <input id="cfg-url" placeholder="API Base URL" value="http://127.0.0.1:8080/v1/chat/completions">
            <input id="cfg-model" placeholder="Model name" value="llama-3.1-8b-instruct">
            <input id="cfg-key" type="password" placeholder="API Key (leave empty for local)">
            <button onclick="saveConfig()">Save Configuration</button>
        </div>
        <p id="cfg-status" style="margin-top:15px;color:green;font-weight:bold;"></p>
    </div>
</div>

<script>
    function switchTab(n) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab')[n].classList.add('active');
        document.querySelectorAll('.tab-content')[n].classList.add('active');
        if (n === 1) refreshLog();
    }

    function addMessage(text, cls) {
        const chat = document.getElementById('chat');
        const div = document.createElement('div');
        div.className = `message ${cls}`;
        div.textContent = text;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    async function sendMessage() {
        const text = document.getElementById('input').value.trim();
        if (!text) return;
        addMessage(text, 'user');
        document.getElementById('input').value = '';

        const evt = new EventSource(`/chat?prompt=${encodeURIComponent(text)}`);
        evt.onmessage = e => {
            if (e.data === '[DONE]') { evt.close(); return; }
            if (e.data.includes('ðŸ”§ Used tool:')) {
                addMessage(e.data, 'tool-used');
            } else {
                const last = document.querySelector('#chat .assistant:last-child');
                if (last) last.textContent += e.data;
                else addMessage(e.data, 'assistant');
            }
        };
    }

    async function saveConfig() {
        const url = document.getElementById('cfg-url').value.trim();
        const model = document.getElementById('cfg-model').value.trim();
        const key = document.getElementById('cfg-key').value.trim();

        const res = await fetch('/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url, model, key})
        });

        const status = document.getElementById('cfg-status');
        if (res.ok) {
            status.style.color = 'green';
            status.textContent = 'âœ“ Configuration saved successfully!';
        } else {
            status.style.color = 'red';
            status.textContent = 'âœ— Failed to save configuration';
        }
        setTimeout(() => status.textContent = '', 4000);
    }

    async function refreshLog() {
        const res = await fetch('/tool-log');
        const log = await res.json();
        const div = document.getElementById('log');
        let html = '';
        log.forEach(entry => {
            html += `<strong>${entry.time} â€” ${entry.tool}</strong><br>`;
            html += `Args: ${JSON.stringify(entry.args)}<br>`;
            html += `Result: ${JSON.stringify(entry.result, null, 2)}<br><hr>`;
        });
        div.innerHTML = html || 'No tool interactions yet.';
    }

    async function loadTools() {
        const res = await fetch('/tools');
        const list = await res.json();
        const select = document.getElementById('tool-select');
        list.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t; opt.textContent = t;
            select.appendChild(opt);
        });
    }

    async function testTool() {
        const tool = document.getElementById('tool-select').value;
        const argsStr = document.getElementById('tool-args').value.trim() || '{}';
        const res = await fetch(`/test?tool=${tool}&args=${encodeURIComponent(argsStr)}`);
        const data = await res.json();
        const pre = document.getElementById('test-result');
        pre.textContent = JSON.stringify(data, null, 2);
        pre.style.display = 'block';
        refreshLog();
    }

    document.getElementById('input').addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
    });

    loadTools();
</script>
</body>
</html>
